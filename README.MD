# Event Sourcing CQRS avec Axon Framework

Application bancaire implÃ©mentant les patterns **Event Sourcing** et **CQRS** avec Axon Framework et Spring Boot.

## ğŸ“‹ Table des MatiÃ¨res

- [Vue d'Ensemble](#vue-densemble)
- [Technologies](#technologies)
- [Architecture](#architecture)
- [Structure du Projet](#structure-du-projet)
- [Installation](#installation)
- [Configuration](#configuration)
- [API Endpoints](#api-endpoints)
- [ModÃ¨le de Domaine](#modÃ¨le-de-domaine)
- [Flux de DonnÃ©es](#flux-de-donnÃ©es)
- [Architecture CQRS DÃ©taillÃ©e](#architecture-cqrs-dÃ©taillÃ©e)
- [RÃ¨gles MÃ©tier](#rÃ¨gles-mÃ©tier)


## ğŸ¯ Vue d'Ensemble

Cette application permet de gÃ©rer des comptes bancaires avec une sÃ©paration complÃ¨te entre les opÃ©rations d'Ã©criture (Command) et de lecture (Query).

### OpÃ©rations Command (Ã‰criture)
- âœ… CrÃ©ation de compte avec solde initial
- âœ… CrÃ©dit de compte
- âœ… DÃ©bit de compte
- âœ… Changement de statut de compte
- âœ… Consultation de l'historique d'Ã©vÃ©nements

### OpÃ©rations Query (Lecture)
- âœ… Liste de tous les comptes
- âœ… RelevÃ© de compte avec historique des opÃ©rations
- âœ… Projections optimisÃ©es pour la lecture

### Patterns ImplÃ©mentÃ©s

**Event Sourcing**
- Tous les changements d'Ã©tat sont stockÃ©s comme Ã©vÃ©nements immuables
- L'Ã©tat actuel est reconstruit en rejouant les Ã©vÃ©nements
- TraÃ§abilitÃ© et auditabilitÃ© complÃ¨tes

**CQRS (Command Query Responsibility Segregation)**
- SÃ©paration complÃ¨te entre commandes (Ã©criture) et requÃªtes (lecture)
- ModÃ¨les de donnÃ©es diffÃ©rents pour Command et Query
- Architecture orientÃ©e Ã©vÃ©nements
- ScalabilitÃ© et performance optimisÃ©es

**Domain-Driven Design (DDD)**
- AgrÃ©gats pour encapsuler la logique mÃ©tier
- Validation des rÃ¨gles mÃ©tier au niveau de l'agrÃ©gat

## ğŸ› ï¸ Technologies

### Framework Principal
- **Spring Boot** 3.3.4
- **Java** 21
- **Axon Framework** 4.12.2

### Base de DonnÃ©es
- **PostgreSQL** (production)
- **H2** (dÃ©veloppement/test)

### DÃ©pendances
- Spring Data JPA
- Lombok
- SpringDoc OpenAPI / Swagger UI
- Spring Web MVC

## ğŸ—ï¸ Architecture

### Architecture CQRS ComplÃ¨te

![img_1.png](images/img_1.png)

## ğŸ“ Structure du Projet

```
src/main/java/org/example/eventsourcingcqrsspringbootaxon/
â”‚
â”œâ”€â”€ command/                              # WRITE SIDE (CQRS)
â”‚   â”œâ”€â”€ aggregate/
â”‚   â”‚   â””â”€â”€ AccountAggregate.java         # AgrÃ©gat principal
â”‚   â”‚
â”‚   â”œâ”€â”€ command/
â”‚   â”‚   â”œâ”€â”€ AddAccountCommand.java        # Commandes
â”‚   â”‚   â”œâ”€â”€ CreditAccountCommand.java
â”‚   â”‚   â”œâ”€â”€ DebitAccountCommand.java
â”‚   â”‚   â””â”€â”€ UpdateAccountStatusCommand.java
â”‚   â”‚
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ AccountCommandController.java # API REST Command
â”‚   â”‚
â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ AddNewAccountRequestDTO.java  # DTOs Command
â”‚       â”œâ”€â”€ CreditAccountRequestDTO.java
â”‚       â”œâ”€â”€ DebitAccountRequestDTO.java
â”‚       â””â”€â”€ UpdateAccountStatusRequestDTO.java
â”‚
â”œâ”€â”€ query/                                # READ SIDE (CQRS)
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â””â”€â”€ AccountQueryController.java   # API REST Query
â”‚   â”‚
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â””â”€â”€ AccountStatementResponseDTO.java # DTOs Query
â”‚   â”‚
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”œâ”€â”€ Account.java                  # EntitÃ© JPA Account
â”‚   â”‚   â”œâ”€â”€ AccountOperation.java         # EntitÃ© JPA Operation
â”‚   â”‚   â””â”€â”€ OperationType.java            # Enum (DEBIT/CREDIT)
â”‚   â”‚
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”œâ”€â”€ AccountEventHandler.java      # Gestion Ã©vÃ©nements â†’ DB
â”‚   â”‚   â””â”€â”€ AccountQueryHandler.java      # Gestion requÃªtes
â”‚   â”‚
â”‚   â”œâ”€â”€ query/
â”‚   â”‚   â”œâ”€â”€ GetAllAccountsQuery.java      # RequÃªtes Query
â”‚   â”‚   â””â”€â”€ GetAccountStatementQuery.java
â”‚   â”‚
â”‚   â””â”€â”€ repository/
â”‚       â”œâ”€â”€ AccountRepository.java        # JPA Repository
â”‚       â””â”€â”€ OperationRepository.java
â”‚
â”œâ”€â”€ events/                               # SHARED (Command & Query)
â”‚   â”œâ”€â”€ AccountCreatedEvent.java          # Ã‰vÃ©nements
â”‚   â”œâ”€â”€ AccountActivatedEvent.java
â”‚   â”œâ”€â”€ AccountCreditedEvent.java
â”‚   â”œâ”€â”€ AccountDebitedEvent.java
â”‚   â””â”€â”€ AccountStatusUpdatedEvent.java
â”‚
â””â”€â”€ enums/
    â””â”€â”€ AccountStatus.java                # Ã‰numÃ©ration des statuts
```

## ğŸš€ Installation

### PrÃ©requis

- Java 21+
- Maven 3.6+
- PostgreSQL 12+ (ou Docker)
- Docker et Docker Compose (optionnel)

### Option 1 : Installation avec Docker (RecommandÃ©)

#### 1. Cloner le repository
```bash
git clone <repository-url>
cd event-sourcing-cqrs-spring-boot-axon
```

#### 2. CrÃ©er le fichier docker-compose.yml

CrÃ©ez un fichier `docker-compose.yml` Ã  la racine du projet :

```yaml
services:
  postgres:
    image: 'postgres:latest'
    environment:
      - 'POSTGRES_DB=accounts_db'
      - 'POSTGRES_PASSWORD=1234'
      - 'POSTGRES_USER=admin'
    volumes:
      - es-accounts_data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    networks:
      - es-accounts-net
      
  pgadmin4:
    image: dpage/pgadmin4
    restart: always
    ports:
      - "8088:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: root@gmail.com
      PGADMIN_DEFAULT_PASSWORD: root
    volumes:
      - es-accounts_pgadmin_data:/var/lib/pgadmin
    networks:
      - es-accounts-net
      
volumes:
  es-accounts_data:
  es-accounts_pgadmin_data:

networks:
  es-accounts-net:
    driver: bridge
```

#### 3. DÃ©marrer les services Docker
```bash
docker-compose up -d
```

Cette commande va :
- âœ… TÃ©lÃ©charger les images PostgreSQL et pgAdmin4
- âœ… CrÃ©er automatiquement la base de donnÃ©es `accounts_db`
- âœ… Configurer l'utilisateur `admin` avec le mot de passe `1234`
- âœ… DÃ©marrer pgAdmin4 sur http://localhost:8088
- âœ… CrÃ©er les volumes pour la persistance des donnÃ©es

#### 4. VÃ©rifier que les services sont dÃ©marrÃ©s
```bash
docker-compose ps
```

#### 5. AccÃ©der Ã  pgAdmin4
- URL : http://localhost:8088
- Email : root@gmail.com
- Mot de passe : root

**Configuration de la connexion PostgreSQL dans pgAdmin :**
- Host : postgres (nom du service Docker)
- Port : 5432
- Database : accounts_db
- Username : admin
- Password : 1234

#### 6. Compiler le projet
```bash
mvn clean install
```

#### 7. Lancer l'application
```bash
mvn spring-boot:run
```

L'application dÃ©marrera sur `http://localhost:8066`

#### 8. ArrÃªter les services Docker
```bash
docker-compose down
```

Pour supprimer Ã©galement les volumes (âš ï¸ supprime les donnÃ©es) :
```bash
docker-compose down -v
```

---

### Option 2 : Installation Manuelle (Sans Docker)

#### 1. Cloner le repository
```bash
git clone <repository-url>
cd event-sourcing-cqrs-spring-boot-axon
```

#### 2. Installer PostgreSQL
TÃ©lÃ©chargez et installez PostgreSQL depuis https://www.postgresql.org/download/

#### 3. CrÃ©er la base de donnÃ©es
```bash
# Se connecter Ã  PostgreSQL
psql -U postgres

# ExÃ©cuter les commandes SQL
CREATE DATABASE accounts_db;
CREATE USER admin WITH PASSWORD '1234';
GRANT ALL PRIVILEGES ON DATABASE accounts_db TO admin;
\q
```

#### 4. Compiler le projet
```bash
mvn clean install
```

#### 5. Lancer l'application
```bash
mvn spring-boot:run
```

L'application dÃ©marrera sur `http://localhost:8066`

## âš™ï¸ Configuration

### application.properties

```properties
# Serveur
server.port=8066

# Base de donnÃ©es PostgreSQL
spring.datasource.url=jdbc:postgresql://localhost:5432/accounts_db
spring.datasource.username=admin
spring.datasource.password=1234

# JPA/Hibernate
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.hibernate.show-sql=true

# Axon Serializers
axon.serializer.events=jackson
axon.serializer.messages=xstream
axon.serializer.general=jackson
```

### Variable d'environnement

```bash
export DB_URL=jdbc:postgresql://localhost:5432/accounts_db
```

## ğŸ“¡ API Endpoints

### Command Side (Ã‰criture)

**Base URL** : `http://localhost:8066/commands/accounts`

#### CrÃ©er un compte
```http
POST /add
Content-Type: application/json

{
  "initialBalance": 1000.0,
  "currency": "EUR"
}
```

**RÃ©ponse** : ID du compte crÃ©Ã© (UUID)

#### CrÃ©diter un compte
```http
POST /credit
Content-Type: application/json

{
  "accountId": "uuid-du-compte",
  "amount": 500.0,
  "currency": "EUR"
}
```

#### DÃ©biter un compte
```http
POST /debit
Content-Type: application/json

{
  "accountId": "uuid-du-compte",
  "amount": 200.0,
  "currency": "EUR"
}
```

#### Changer le statut
```http
PUT /updateStatus
Content-Type: application/json

{
  "accountId": "uuid-du-compte",
  "status": "SUSPENDED"
}
```

**Statuts disponibles** : `CREATED`, `ACTIVATED`, `SUSPENDED`, `BLOCKED`

#### Consulter l'historique d'Ã©vÃ©nements
```http
GET /events/{accountId}
```

**RÃ©ponse** : Stream de tous les Ã©vÃ©nements du compte

---

### Query Side (Lecture)

**Base URL** : `http://localhost:8066/query/accounts`

#### Obtenir tous les comptes
```http
GET /all
```

**RÃ©ponse**
```json
[
  {
    "id": "uuid-1",
    "createdAt": "2024-01-15T10:30:00Z",
    "balance": 1500.0,
    "status": "ACTIVATED",
    "currency": "EUR"
  },
  {
    "id": "uuid-2",
    "createdAt": "2024-01-16T14:20:00Z",
    "balance": 2300.0,
    "status": "ACTIVATED",
    "currency": "USD"
  }
]
```

#### Obtenir le relevÃ© de compte
```http
GET /accountStatement/{accountId}
```

**RÃ©ponse**
```json
{
  "account": {
    "id": "uuid-du-compte",
    "createdAt": "2024-01-15T10:30:00Z",
    "balance": 1500.0,
    "status": "ACTIVATED",
    "currency": "EUR"
  },
  "operations": [
    {
      "id": 1,
      "date": "2024-01-15T10:30:00Z",
      "amount": 1000.0,
      "currency": "EUR",
      "type": "CREDIT"
    },
    {
      "id": 2,
      "date": "2024-01-16T11:45:00Z",
      "amount": 500.0,
      "currency": "EUR",
      "type": "CREDIT"
    },
    {
      "id": 3,
      "date": "2024-01-17T09:15:00Z",
      "amount": 200.0,
      "currency": "EUR",
      "type": "DEBIT"
    }
  ]
}
```

### Documentation Swagger

Accessible sur : `http://localhost:8066/swagger-ui.html`

![img.png](images/img.png)

## ğŸ¨ ModÃ¨le de Domaine

### Command Side (Write Model)

#### AccountAggregate

**Attributs**
- `accountId` : String (identifiant unique)
- `currentBalance` : double (solde actuel)
- `currency` : String (devise)
- `status` : AccountStatus (statut du compte)

**Commandes SupportÃ©es**
1. `AddAccountCommand` - CrÃ©ation de compte
2. `CreditAccountCommand` - CrÃ©dit
3. `DebitAccountCommand` - DÃ©bit
4. `UpdateAccountStatusCommand` - Changement de statut

**Ã‰vÃ©nements Ã‰mis**
1. `AccountCreatedEvent` - Compte crÃ©Ã©
2. `AccountActivatedEvent` - Compte activÃ©
3. `AccountCreditedEvent` - Compte crÃ©ditÃ©
4. `AccountDebitedEvent` - Compte dÃ©bitÃ©
5. `AccountStatusUpdatedEvent` - Statut modifiÃ©

---

### Query Side (Read Model)

#### Account Entity (JPA)

**Attributs**
- `id` : String (PK)
- `createdAt` : Instant (date de crÃ©ation)
- `balance` : double (solde)
- `status` : AccountStatus (statut)
- `currency` : String (devise)

#### AccountOperation Entity (JPA)

**Attributs**
- `id` : Long (PK, auto-gÃ©nÃ©rÃ©)
- `date` : Instant (date de l'opÃ©ration)
- `amount` : double (montant)
- `currency` : String (devise)
- `type` : OperationType (DEBIT ou CREDIT)
- `account` : Account (relation ManyToOne)

#### RequÃªtes SupportÃ©es
1. `GetAllAccountsQuery` - Liste tous les comptes
2. `GetAccountStatementQuery` - RelevÃ© complet d'un compte

## ğŸ”„ Flux de DonnÃ©es

### Command Side - CrÃ©ation de Compte

```
1. POST /commands/accounts/add â†’ AddAccountCommand
2. AccountAggregate valide : initialBalance >= 0
3. AccountCreatedEvent Ã©mis â†’ EventStore
4. AccountActivatedEvent Ã©mis â†’ EventStore
5. Ã‰tat Command : Aggregate mis Ã  jour en mÃ©moire
```

### Query Side - Projection des Ã‰vÃ©nements

```
1. EventStore publie AccountCreatedEvent
2. AccountEventHandler.on(AccountCreatedEvent) reÃ§oit l'Ã©vÃ©nement
3. CrÃ©ation de l'entitÃ© Account en base de donnÃ©es
4. AccountRepository.save(account)
   
5. EventStore publie AccountActivatedEvent
6. AccountEventHandler.on(AccountActivatedEvent) reÃ§oit l'Ã©vÃ©nement
7. Mise Ã  jour du statut du compte en base de donnÃ©es
```

### Query Side - Lecture des DonnÃ©es

```
1. GET /query/accounts/all â†’ GetAllAccountsQuery
2. AccountQueryHandler.on(GetAllAccountsQuery)
3. AccountRepository.findAll()
4. Retour de la liste des comptes
```

### OpÃ©ration ComplÃ¨te - CrÃ©dit de Compte

```
COMMAND SIDE:
1. POST /commands/accounts/credit â†’ CreditAccountCommand
2. AccountAggregate valide et Ã©met AccountCreditedEvent
3. Ã‰vÃ©nement persistÃ© dans EventStore

QUERY SIDE:
4. AccountEventHandler.on(AccountCreditedEvent)
5. CrÃ©ation de AccountOperation (type=CREDIT)
6. OperationRepository.save(operation)
7. Mise Ã  jour du balance du Account
8. AccountRepository.save(account)

LECTURE:
9. GET /query/accounts/accountStatement/{id}
10. Retour du compte avec toutes les opÃ©rations
```

## ğŸ›ï¸ Architecture CQRS DÃ©taillÃ©e

### SÃ©paration Command / Query

| Aspect | Command Side | Query Side |
|--------|--------------|------------|
| **ResponsabilitÃ©** | Ã‰criture et validation | Lecture optimisÃ©e |
| **ModÃ¨le de donnÃ©es** | Aggregate (en mÃ©moire) | EntitÃ©s JPA (PostgreSQL) |
| **Stockage** | EventStore | Tables relationnelles |
| **Performance** | Validations mÃ©tier | Lectures rapides |
| **ComplexitÃ©** | Logique mÃ©tier complexe | RequÃªtes simples |
| **ScalabilitÃ©** | Scaling vertical | Scaling horizontal |

### Event Handlers

#### AccountEventHandler
Responsable de la synchronisation EventStore â†’ Base de donnÃ©es de lecture

**Ã‰vÃ©nements traitÃ©s :**
- `AccountCreatedEvent` â†’ CrÃ©e l'entitÃ© Account
- `AccountActivatedEvent` â†’ Met Ã  jour le statut
- `AccountCreditedEvent` â†’ CrÃ©e l'opÃ©ration CREDIT + met Ã  jour le solde
- `AccountDebitedEvent` â†’ CrÃ©e l'opÃ©ration DEBIT + met Ã  jour le solde
- `AccountStatusUpdatedEvent` â†’ Met Ã  jour le statut

**CaractÃ©ristiques :**
- Utilise `EventMessage` pour obtenir le timestamp
- OpÃ©rations transactionnelles avec JPA
- Journalisation complÃ¨te des Ã©vÃ©nements reÃ§us

#### AccountQueryHandler
Responsable du traitement des requÃªtes de lecture

**RequÃªtes traitÃ©es :**
- `GetAllAccountsQuery` â†’ Liste tous les comptes
- `GetAccountStatementQuery` â†’ RelevÃ© dÃ©taillÃ© avec opÃ©rations

**CaractÃ©ristiques :**
- AccÃ¨s direct aux repositories JPA
- Pas de logique mÃ©tier
- Retours optimisÃ©s pour la lecture

### Repositories

```java
// AccountRepository - Gestion des comptes
public interface AccountRepository extends JpaRepository<Account, String> {
    // HÃ©rite de toutes les mÃ©thodes CRUD de JPA
}

// OperationRepository - Gestion des opÃ©rations
public interface OperationRepository extends JpaRepository<AccountOperation, Long> {
    List<AccountOperation> findByAccountId(String id);
}
```

### DTOs Query

```java
// RÃ©ponse enrichie avec compte + historique
public record AccountStatementResponseDTO(
    Account account, 
    List<AccountOperation> operations
) { }
```

## âœ… RÃ¨gles MÃ©tier

### Validations Command Side

| RÃ¨gle | Description |
|-------|-------------|
| Solde initial | Ne peut pas Ãªtre nÃ©gatif |
| Montants | Doivent Ãªtre strictement positifs |
| OpÃ©rations | Possibles uniquement sur comptes ACTIVATED |
| DÃ©bit | Requiert un solde suffisant |
| Statut | Impossible de changer vers le statut actuel |

### Workflow Complet

#### 1. CrÃ©ation de Compte

```
Command Side:
â”œâ”€ AddAccountCommand reÃ§ue
â”œâ”€ Validation : initialBalance >= 0
â”œâ”€ AccountCreatedEvent Ã©mis
â””â”€ AccountActivatedEvent Ã©mis

Query Side:
â”œâ”€ AccountCreatedEvent reÃ§u
â”‚  â””â”€ Account crÃ©Ã© en DB
â””â”€ AccountActivatedEvent reÃ§u
   â””â”€ Account.status = ACTIVATED
```

#### 2. OpÃ©ration de CrÃ©dit

```
Command Side:
â”œâ”€ CreditAccountCommand reÃ§ue
â”œâ”€ Validations:
â”‚  â”œâ”€ Compte ACTIVATED
â”‚  â””â”€ amount > 0
â””â”€ AccountCreditedEvent Ã©mis

Query Side:
â”œâ”€ AccountCreditedEvent reÃ§u
â”œâ”€ AccountOperation crÃ©Ã©e (type=CREDIT)
â””â”€ Account.balance += amount
```

#### 3. OpÃ©ration de DÃ©bit

```
Command Side:
â”œâ”€ DebitAccountCommand reÃ§ue
â”œâ”€ Validations:
â”‚  â”œâ”€ Compte ACTIVATED
â”‚  â”œâ”€ amount > 0
â”‚  â””â”€ currentBalance >= amount
â””â”€ AccountDebitedEvent Ã©mis 

Query Side:
â”œâ”€ AccountDebitedEvent reÃ§u
â”œâ”€ AccountOperation crÃ©Ã©e (type=DEBIT)
â””â”€ Account.balance -= amount
```



**Note** : Ce projet est Ã  but Ã©ducatif et dÃ©montre l'implÃ©mentation complÃ¨te des patterns Event Sourcing et CQRS avec Axon Framework. Il illustre une architecture microservices moderne avec sÃ©paration claire des responsabilitÃ©s.